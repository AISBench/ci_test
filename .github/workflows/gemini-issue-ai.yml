name: Gemini AI æ‰‹åŠ¨è§¦å‘å›å¤Issue
on:
  # è§¦å‘æ¡ä»¶1ï¼šæ–°å»ºIssueï¼ˆå¯é€‰ä¿ç•™ï¼Œä¹Ÿå¯åˆ é™¤ä»…ä¿ç•™è¯„è®ºè§¦å‘ï¼‰
  issues:
    types: [opened]
  # è§¦å‘æ¡ä»¶2ï¼šæ–°å¢Issueè¯„è®ºï¼ˆæ ¸å¿ƒï¼Œæ£€æµ‹@issue_bot_cnï¼‰
  issue_comment:
    types: [created]

jobs:
  gemini-ai-reply:
    runs-on: ubuntu-latest
    permissions:
      issues: write  # è¯„è®ºIssueæƒé™
      contents: read # è¯»å–ä»“åº“å†…å®¹æƒé™
    # ä»…æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶æ‰§è¡Œï¼šè¯„è®ºå«@issue_bot_cn æˆ– æ–°å»ºIssueï¼ˆå¯é€‰ï¼‰
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@issue_bot_cn')) ||
      (github.event_name == 'issues' && github.event.action == 'opened')
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆè¯»å–ä¸Šä¸‹æ–‡ï¼‰
        uses: actions/checkout@v4

      - name: è·å–å†å²Issueä½œä¸ºä¸Šä¸‹æ–‡
        id: get_issues
        uses: actions/github-script@v7
        with:
          script: |
            // è·å–æœ€è¿‘30æ¡å·²å…³é—­çš„Issueï¼ˆä¸­æ–‡ä¼˜åŒ–ï¼Œç²¾ç®€å†…å®¹ï¼‰
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              per_page: 30
            });
            // ç²¾ç®€ä¸Šä¸‹æ–‡ï¼Œä¿ç•™æ ‡é¢˜+æ ¸å¿ƒå†…å®¹ï¼ˆé¿å…è¶…é•¿ï¼‰
            const issueContext = issues.data.map(issue =>
              `Issue #${issue.number}ï¼š${issue.title}\næ ¸å¿ƒå†…å®¹ï¼š${issue.body ? issue.body.substring(0, 300) : 'æ— '}`
            ).join('\n\n');
            core.setOutput('context', issueContext);

      - name: æå–è§¦å‘è¯„è®ºçš„é—®é¢˜ï¼ˆä»…æ‰‹åŠ¨è§¦å‘æ—¶ï¼‰
        id: get_comment_content
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            // è¿‡æ»¤æ‰@issue_bot_cnï¼Œä»…ä¿ç•™å®é™…é—®é¢˜å†…å®¹
            const commentBody = github.event.comment.body.replace(/@issue_bot_cn/g, '').trim();
            core.setOutput('question', commentBody);

      - name: å‡†å¤‡å¾…å›å¤é—®é¢˜ï¼ˆé’ˆå¯¹Issueæ‰“å¼€äº‹ä»¶ï¼‰
        id: get_issue_content
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const issueTitle = github.event.issue.title;
            const issueBody = github.event.issue.body || 'æ— ';
            const truncatedBody = issueBody.length > 500 ? issueBody.substring(0, 500) : issueBody;
            const issueContent = `æ ‡é¢˜ï¼š${issueTitle}\nå†…å®¹ï¼š${truncatedBody}`;
            core.setOutput('issue_content', issueContent);

      - name: è°ƒç”¨Geminiå…è´¹APIç”Ÿæˆå›å¤
        id: gemini_reply
        uses: actions/github-script@v7
        with:
          script: |
            const { Octokit } = require('octokit');
            const fetch = require('node-fetch');

            // è·å–å¿…è¦çš„ä¸Šä¸‹æ–‡
            const issueContext = '${{ steps.get_issues.outputs.context }}';
            const commentQuestion = '${{ steps.get_comment_content.outputs.question }}';
            const issueContent = '${{ steps.get_issue_content.outputs.issue_content }}';
            const geminiApiKey = '${{ secrets.GEMINI_API_KEY }}';
            const eventName = '${{ github.event_name }}';

            // ç¡®å®šå¾…å›å¤çš„é—®é¢˜
            let questionToAnswer;
            if (eventName === 'issue_comment') {
              questionToAnswer = commentQuestion;
            } else {
              questionToAnswer = issueContent;
            }

            try {
              // è°ƒç”¨Gemini API
              const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  contents: [
                    {
                      parts: [
                        {
                          text: `ä½ æ˜¯è¯¥GitHubä»“åº“çš„AIåŠ©æ‰‹ï¼ŒåŸºäºä»¥ä¸‹å†å²Issueä¸Šä¸‹æ–‡å’Œå®˜æ–¹æ–‡æ¡£å‚è€ƒï¼Œç®€æ´ã€å‡†ç¡®åœ°å›å¤é—®é¢˜ï¼ˆä»…ç”¨ä¸­æ–‡ï¼Œé¿å…å†—ä½™ï¼‰ï¼š\n\nã€å®˜æ–¹æ–‡æ¡£å‚è€ƒã€‘\nhttps://ais-bench-benchmark-rf.readthedocs.io/ \n\nã€å†å²Issueä¸Šä¸‹æ–‡ã€‘\n${issueContext}\n\nã€å¾…å›å¤çš„é—®é¢˜ã€‘\n${questionToAnswer}\n\nã€å›å¤è¦æ±‚ã€‘\n1. åªå›ç­”å’Œä»“åº“ç›¸å…³çš„é—®é¢˜ï¼Œæ— å…³é—®é¢˜è¯·æç¤ºâ€œè¯¥é—®é¢˜ä¸ä»“åº“æ— å…³ï¼Œå»ºè®®è¡¥å……ç›¸å…³ä¿¡æ¯â€ï¼›\n2. ä¸Šä¸‹æ–‡æ— ç›¸å…³ä¿¡æ¯æ—¶ï¼Œæç¤ºâ€œæš‚æœªæ‰¾åˆ°ç›¸å…³è§£ç­”ï¼Œå¯å‚è€ƒä»“åº“å®˜æ–¹æ–‡æ¡£ï¼ˆhttps://ais-bench-benchmark-rf.readthedocs.io/ï¼‰ã€READMEæˆ–è”ç³»ç»´æŠ¤è€…â€ï¼›\n3. å›å¤æ§åˆ¶åœ¨500å­—ä»¥å†…ï¼Œè¯­æ°”å‹å¥½ã€‚`
                        }
                      ]
                    }
                  ],
                  generationConfig: {
                    temperature: 0.3,
                    maxOutputTokens: 500
                  }
                })
              });

              const data = await response.json();
              const aiReply = data.candidates[0].content.parts[0].text.trim();
              core.setOutput('ai_reply', aiReply);
            } catch (error) {
              console.error('Gemini APIè°ƒç”¨å¤±è´¥:', error);
              core.setOutput('ai_reply', '');
            }

      - name: å‘å¸ƒAIå›å¤åˆ°Issue
        uses: actions/github-script@v7
        with:
          script: |
            const aiReply = '${{ steps.gemini_reply.outputs.ai_reply }}';
            const issueNumber = ${{ github.event.issue.number }};

            try {
              if (aiReply) {
                // å‘å¸ƒæ­£å¸¸AIå›å¤
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `ğŸ¤– Gemini AI å›å¤ï¼š\n\n${aiReply}`
                });
              } else {
                // å…œåº•å›å¤ï¼ˆAPIè°ƒç”¨å¤±è´¥æ—¶ï¼‰
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: "ğŸ¤– æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•ç”Ÿæˆå›å¤ï½å¯å‚è€ƒä»“åº“å®˜æ–¹æ–‡æ¡£ï¼ˆhttps://ais-bench-benchmark-rf.readthedocs.io/ï¼‰æˆ–å†å²Issueï¼Œæˆ–ç¨åé‡è¯•ã€‚"
                });
              }
            } catch (e) {
              console.error('å‘å¸ƒè¯„è®ºå¤±è´¥:', e);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: "ğŸ¤– æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•ç”Ÿæˆå›å¤ï½å¯å‚è€ƒä»“åº“å®˜æ–¹æ–‡æ¡£ï¼ˆhttps://ais-bench-benchmark-rf.readthedocs.io/ï¼‰æˆ–å†å²Issueï¼Œæˆ–ç¨åé‡è¯•ã€‚"
              });
            }